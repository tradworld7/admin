<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trade World - Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --primary-color: #4361ee;
  --success-color: #4cc9f0;
  --warning-color: #f8961e;
  --danger-color: #f72585;
  --light-color: #f8f9fa;
  --dark-color: #212529;
  --gray-light: #e9ecef;
  --border-radius: 10px;
  --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:#f5f7fa;color:var(--dark-color);}
header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:1000;}
.logo{display:flex;align-items:center;gap:0.5rem;}
.logo-icon{color:var(--primary-color);font-size:1.5rem;}
.menu-toggle{background:none;border:none;font-size:1.5rem;display:none;}
.sidebar{background:#fff;box-shadow:2px 0 10px rgba(0,0,0,0.1);width:250px;position:fixed;top:70px;left:0;height:calc(100vh - 70px);overflow-y:auto;transition:0.3s;}
.sidebar-menu{list-style:none;}
.sidebar-menu li a{display:flex;align-items:center;padding:0.8rem 1.5rem;color:var(--dark-color);text-decoration:none;border-left:3px solid transparent;}
.sidebar-menu li a:hover, .sidebar-menu li a.active{background:#e6e9ff;color:var(--primary-color);border-left-color:var(--primary-color);}
.sidebar-menu li a i{margin-right:0.8rem;}
.main-content{margin-top:70px;margin-left:250px;padding:2rem;}
.page-title{font-size:1.8rem;margin-bottom:1.5rem;color:var(--dark-color);}

/* Summary Cards */
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem;}
.card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:1rem;text-align:center;}
.card h3{font-size:1.2rem;margin-bottom:0.5rem;}
.card p{font-size:1.5rem;font-weight:600;}

/* Sections */
.section{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:1.5rem;margin-bottom:2rem;overflow-x:auto;}
.section h2{margin-bottom:1rem;}

/* Tables */
table{width:100%;border-collapse:collapse;}
th,td{padding:0.6rem;border:1px solid var(--gray-light);text-align:left;}
th{background:var(--primary-color);color:#fff;}
button.action{padding:0.3rem 0.6rem;border:none;border-radius:5px;cursor:pointer;}
button.approve{background:var(--success-color);color:#fff;}
button.reject{background:var(--danger-color);color:#fff;}

/* Responsive */
@media(max-width:992px){
  .sidebar{left:-250px;}
  .sidebar.open{left:0;}
  .main-content{margin-left:0;}
  .menu-toggle{display:block;}
}
</style>
</head>
<body>
<header>
  <div class="logo">
    <i class="fas fa-chart-line logo-icon"></i>
    <span class="logo-text">Admin Panel</span>
  </div>
  <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
</header>
<aside class="sidebar" id="sidebar">
  <ul class="sidebar-menu">
    <li><a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
    <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
  </ul>
</aside>

<main class="main-content">
  <h1 class="page-title">Admin Dashboard</h1>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="card"><h3>Active Users</h3><p id="activeUsers">0</p></div>
    <div class="card"><h3>Inactive Users</h3><p id="inactiveUsers">0</p></div>
    <div class="card"><h3>Pending Deposits</h3><p id="pendingDeposits">0</p></div>
    <div class="card"><h3>Pending Withdrawals</h3><p id="pendingWithdrawals">0</p></div>
    <div class="card"><h3>System Profit</h3><p id="systemProfit">$0.00</p></div>
  </div>

  <!-- Deposits -->
  <div class="section">
    <h2>Pending Deposit Requests</h2>
    <table>
      <thead>
        <tr><th>User</th><th>Amount</th><th>Date</th><th>Action</th></tr>
      </thead>
      <tbody id="depositTable"></tbody>
    </table>
  </div>

  <!-- Withdrawals -->
  <div class="section">
    <h2>Pending Withdrawal Requests</h2>
    <table>
      <thead>
        <tr><th>User</th><th>Amount</th><th>Date</th><th>Action</th></tr>
      </thead>
      <tbody id="withdrawalTable"></tbody>
    </table>
  </div>

  <!-- Active Users -->
  <div class="section">
    <h2>Active Users</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>UID</th><th>Email</th><th>Investment</th><th>Status</th></tr>
      </thead>
      <tbody id="activeUsersTable"></tbody>
    </table>
  </div>

  <!-- Inactive Users -->
  <div class="section">
    <h2>Inactive Users</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>UID</th><th>Email</th><th>Status</th></tr>
      </thead>
      <tbody id="inactiveUsersTable"></tbody>
    </table>
  </div>

  <!-- Package Purchases -->
  <div class="section">
    <h2>Package Purchases</h2>
    <table>
      <thead>
        <tr><th>User</th><th>Package</th><th>Date</th></tr>
      </thead>
      <tbody id="packagesTable"></tbody>
    </table>
  </div>

  <!-- Trading Profit Distribution -->
  <div class="section">
    <h2>Trading Profit Distribution</h2>
    <p>Current Pool Balance: $<span id="poolBalance">0.00</span></p>
    <label>Distribution Percentage (%)</label>
    <input type="number" id="distributionPercent" value="0" min="0" max="100">
    <button id="distributeProfit">Distribute Profit</button>
  </div>
</main>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBshAGZScyo7PJegLHMzORbkkrCLGD6U5s",
  authDomain: "mywebsite-600d3.firebaseapp.com",
  databaseURL: "https://mywebsite-600d3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mywebsite-600d3",
  storageBucket: "mywebsite-600d3.appspot.com",
  messagingSenderId: "584485288598",
  appId: "1:584485288598:web:01856eaa18ba5ada49e0b7"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Load Dashboard Summary
async function loadSummary() {
  const usersSnap = await get(ref(db, "users"));
  let active = 0, inactive = 0, totalProfit = 0;
  if (usersSnap.exists()) {
    const users = usersSnap.val();
    for (const uid in users) {
      const user = users[uid];
      const invest = user.packages ? Object.values(user.packages).reduce((sum,p)=>sum+p.amount,0) : 0;
      if (invest > 0) active++; else inactive++;
    }
    document.getElementById("activeUsers").textContent = active;
    document.getElementById("inactiveUsers").textContent = inactive;
  }
  const poolSnap = await get(ref(db, "system/tradingPool"));
  if (poolSnap.exists()) totalProfit = poolSnap.val();
  document.getElementById("systemProfit").textContent = "$" + totalProfit.toFixed(2);
}
loadSummary();

// Load Deposits
async function loadDeposits() {
  const snap = await get(ref(db, "deposits"));
  const table = document.getElementById("depositTable");
  table.innerHTML = "";
  if (snap.exists()) {
    const data = snap.val();
    let pendingCount = 0;
    for (const id in data) {
      const dep = data[id];
      if (dep.status === "pending") {
        pendingCount++;
        const row = `<tr>
          <td>${dep.userName}</td>
          <td>$${dep.amount}</td>
          <td>${new Date(dep.date).toLocaleString()}</td>
          <td>
            <button class="action approve" onclick="approveDeposit('${id}', '${dep.userId}', ${dep.amount})">Approve</button>
            <button class="action reject" onclick="rejectDeposit('${id}')">Reject</button>
          </td>
        </tr>`;
        table.innerHTML += row;
      }
    }
    document.getElementById("pendingDeposits").textContent = pendingCount;
  }
}
window.approveDeposit = async function(id, uid, amount) {
  const userSnap = await get(ref(db, "users/" + uid));
  if (userSnap.exists()) {
    const user = userSnap.val();
    await update(ref(db, "users/" + uid), { balance: (user.balance || 0) + amount });
    await update(ref(db, "deposits/" + id), { status: "approved" });
    loadDeposits();
    loadSummary();
  }
}
window.rejectDeposit = async function(id) {
  await update(ref(db, "deposits/" + id), { status: "rejected" });
  loadDeposits();
}

// Load Withdrawals
async function loadWithdrawals() {
  const snap = await get(ref(db, "withdrawals"));
  const table = document.getElementById("withdrawalTable");
  table.innerHTML = "";
  if (snap.exists()) {
    const data = snap.val();
    let pendingCount = 0;
    for (const id in data) {
      const wd = data[id];
      if (wd.status === "pending") {
        pendingCount++;
        const row = `<tr>
          <td>${wd.userName}</td>
          <td>$${wd.amount}</td>
          <td>${new Date(wd.date).toLocaleString()}</td>
          <td>
            <button class="action approve" onclick="approveWithdrawal('${id}', '${wd.userId}', ${wd.amount})">Approve</button>
            <button class="action reject" onclick="rejectWithdrawal('${id}')">Reject</button>
          </td>
        </tr>`;
        table.innerHTML += row;
      }
    }
    document.getElementById("pendingWithdrawals").textContent = pendingCount;
  }
}
window.approveWithdrawal = async function(id, uid, amount) {
  const userSnap = await get(ref(db, "users/" + uid));
  if (userSnap.exists()) {
    const user = userSnap.val();
    if ((user.balance || 0) >= amount) {
      await update(ref(db, "users/" + uid), { balance: (user.balance || 0) - amount });
      await update(ref(db, "withdrawals/" + id), { status: "approved" });
      loadWithdrawals();
      loadSummary();
    } else {
      alert("Insufficient balance");
    }
  }
}
window.rejectWithdrawal = async function(id) {
  await update(ref(db, "withdrawals/" + id), { status: "rejected" });
  loadWithdrawals();
}

// Load Users
async function loadUsers() {
  const snap = await get(ref(db, "users"));
  const activeTable = document.getElementById("activeUsersTable");
  const inactiveTable = document.getElementById("inactiveUsersTable");
  const packageTable = document.getElementById("packagesTable");
  activeTable.innerHTML = "";
  inactiveTable.innerHTML = "";
  packageTable.innerHTML = "";
  if (snap.exists()) {
    const users = snap.val();
    for (const uid in users) {
      const u = users[uid];
      const invest = u.packages ? Object.values(u.packages).reduce((sum,p)=>sum+p.amount,0) : 0;
      if (invest > 0) {
        activeTable.innerHTML += `<tr><td>${u.name||""}</td><td>${uid}</td><td>${u.email||""}</td><td>$${invest}</td><td>Active</td></tr>`;
      } else {
        inactiveTable.innerHTML += `<tr><td>${u.name||""}</td><td>${uid}</td><td>${u.email||""}</td><td>Inactive</td></tr>`;
      }
      if (u.packages) {
        for (const pkgId in u.packages) {
          const pkg = u.packages[pkgId];
          packageTable.innerHTML += `<tr><td>${u.name||""}</td><td>$${pkg.amount}</td><td>${new Date(pkg.date).toLocaleString()}</td></tr>`;
        }
      }
    }
  }
}

// Load Pool
async function loadPool() {
  const snap = await get(ref(db, "system/tradingPool"));
  if (snap.exists()) {
    document.getElementById("poolBalance").textContent = parseFloat(snap.val()).toFixed(2);
  }
}
document.getElementById("distributeProfit").addEventListener("click", async ()=>{
  const percent = parseFloat(document.getElementById("distributionPercent").value);
  if (percent <= 0) return alert("Enter valid %");
  const poolSnap = await get(ref(db, "system/tradingPool"));
  if (!poolSnap.exists()) return alert("No pool balance");
  const poolBal = poolSnap.val();
  const totalDist = (poolBal * percent) / 100;

  const usersSnap = await get(ref(db, "users"));
  if (!usersSnap.exists()) return;
  const users = usersSnap.val();
  let totalInvest = 0;
  for (const uid in users) {
    if (users[uid].packages) {
      totalInvest += Object.values(users[uid].packages).reduce((sum,p)=>sum+p.amount,0);
    }
  }
  if (totalInvest <= 0) return alert("No investments found");

  for (const uid in users) {
    if (users[uid].packages) {
      const invest = Object.values(users[uid].packages).reduce((sum,p)=>sum+p.amount,0);
      if (invest > 0) {
        const profit = (invest / totalInvest) * totalDist;
        await update(ref(db, "users/" + uid), { balance: (users[uid].balance || 0) + profit });
      }
    }
  }
  await set(ref(db, "system/tradingPool"), poolBal - totalDist);
  alert("Profit distributed!");
  loadPool();
});

loadDeposits();
loadWithdrawals();
loadUsers();
loadPool();

// Sidebar toggle
document.getElementById("menuToggle").addEventListener("click", ()=>{
  document.getElementById("sidebar").classList.toggle("open");
});
</script>
</body>
</html>
